---

#
# Configure system settings
#
- hosts: catpoo
  sudo: yes
  tasks:
  - copy: dest=/etc/network/interfaces src=files/etc/network/interfaces

  - copy: dest=/etc/dhcp/dhcpd.conf src=files/etc/dhcp/dhcpd.conf

  #
  # DNS server configuration
  #
  - command: mkdir -p /etc/bind/zones
  - copy: dest=/etc/bind/zones/catpoo.local.zone src=files/etc/bind/zones/catpoo.local.zone
  - copy: dest=/etc/bind/zones/rev.37.13.10-in-addr.arpa src=files/etc/bind/zones/rev.37.13.10-in-addr.arpa
  - copy: dest=/etc/bind/named.conf.local src=files/etc/bind/named.conf.local
  - copy: dest=/etc/bind/bad-hosts.conf src=files/etc/bind/bad-hosts.conf

  - copy: dest=/etc/default/isc-dhcp-server src=files/etc/default/isc-dhcp-server

  - copy: dest=/etc/default/hostapd src=files/etc/default/hostapd
  - copy: dest=/etc/hostapd/hostapd.conf src=files/etc/hostapd/hostapd.conf

  #
  # Routing
  #
  - lineinfile: dest=/etc/sysctl.conf line="net.ipv4.ip_forward=1"

  - copy: dest=/etc/motd src=files/etc/motd
  - copy: dest=/etc/rc.local src=files/etc/rc.local
  - copy: dest=/etc/iptables.rules src=files/etc/iptables.rules

  #
  # Anything else?
  #
  - copy: dest=/etc/uv4l/uv4l-raspicam.conf src=files/etc/uv4l/uv4l-raspicam.conf


# -=- -=- -=- -=- -=- -=- -=- -=- -=- -=- -=- -=- -=- -=- -=- -=- -=- -=- -=- #

#
# Configuration of user settings
#
- hosts: catpoo
  tasks:
  #
  # Preferences
  #
  - name: Disable screen startup message
    lineinfile: dest={{ ansible_env.HOME }}/.screenrc line="startup_message off" create=yes
  - name: Vim configuration settings
    lineinfile: dest={{ ansible_env.HOME }}/.vimrc line="set tabstop=4" create=yes
  #
  # Clean out and clone repo
  #
  - name: Clean out CATPOO
    command: sudo rm -rf {{ ansible_env.HOME }}/src/catpoo
  - name: Clone CATPOO repo
    git: repo="git@github.com:timmd909/catpoo.git" clone=yes dest={{ ansible_env.HOME }}/src/catpoo recursive=yes accept_hostkey=yes
  - name: Install vendors
    command: "{{ ansible_env.HOME }}/src/catpoo/composer.phar --no-interaction install"
    args:
      chdir: "{{ ansible_env.HOME }}/src/catpoo/www"
  #
  # Configure CATPOO site
  #
  - name: Setup CATPOO repo
    command: "{{ item }}"
    args:
      chdir: "{{ ansible_env.HOME }}/src/catpoo"
    with_items:
      - cp config/catpoo-site.default config/catpoo-site
      - npm install
  - name: Symlink CATPOO site configuration
    command: "{{ item }}"
    with_items:
      - sudo rm -f /etc/apache2/sites-available/catpoo-site
      - sudo ln -s {{ ansible_env.HOME }}/src/catpoo/config/catpoo-site /etc/apache2/sites-available/catpoo-site
  - name: Set ACL for CATPOO
    command: "{{ item }}"
    with_items:
    - sudo setfacl -R -m www-data:rwx {{ ansible_env.HOME }}/src/catpoo/www/app/cache {{ ansible_env.HOME }}/src/catpoo/www/app/logs
    - sudo setfacl -R -d -m www-data:rwx {{ ansible_env.HOME }}/src/catpoo/www/app/cache {{ ansible_env.HOME }}/src/catpoo/www/app/logs
    - sudo setfacl -R -m "{{ ansible_env.USER}}:rwx" {{ ansible_env.HOME }}/src/catpoo/www/app/cache {{ ansible_env.HOME }}/src/catpoo/www/app/logs
    - sudo setfacl -R -d -m "{{ ansible_env.USER}}:rwx" {{ ansible_env.HOME }}/src/catpoo/www/app/cache {{ ansible_env.HOME }}/src/catpoo/www/app/logs
  - command: sudo rm -f /etc/apache2/sites-available/catpoo
  - command: sudo a2dissite 000-default
  - command: sudo a2ensite catpoo-site
  - command: sudo service apache2 restart
  #
  # SHM configuration
  #
  - cron: name="Create CATPOO TMPFS directory" special_time="reboot" job="mkdir /run/shm/catpoo"
  - cron: name="Create CATPOO TMPFS symlink"  special_time="reboot" job="ln -s /run/shm/catpoo {{ ansible_env.HOME }}/src/catpoo/www/shm"
  #
  # Build any 3rd party libraries necessary
  #
  - name: Build Thrift
    command: "{{ item }}"
    args:
      chdir: "{{ ansible_env.HOME }}/src/catpoo/3rdparty/thrift"
    with_items:
    - ./bootstrap.sh
    - ./configure --without-qt4 --without-csharp --without-java --without-erlang --without-perl --without-haskell --without-go --without-d --with-cpp
    - nice make -j 4
    - sudo make install




