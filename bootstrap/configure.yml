---
#
# Configuration of user settings
#
- hosts: catpoo
  tasks:
  - lineinfile: dest={{ ansible_env.HOME }}/.screenrc line="startup_message off" create=yes
  - lineinfile: dest={{ ansible_env.HOME }}/.vimrc line="set tabstop=4" create=yes
  - command: rm -rf {{ ansible_env.HOME }}/src/catpoo
  - git: repo="git@github.com:timmd909/catpoo.git" clone=yes dest={{ ansible_env.HOME }}/src/catpoo recursive=yes accept_hostkey=yes
  - name: Install vendors
    command: ../composer.phar install
    args:
      chdir: "{{ ansible_env.HOME }}/src/catpoo/www"
  - name: Setup CATPOO repo
    command: "{{ item }}"
    args:
      chdir: "{{ ansible_env.HOME }}/src/catpoo"
    with_items:
      - cp config/catpoo-site.default config/catpoo-site
      - npm install
  - command: sudo ln -s {{ ansible_env.HOME }}/src/catpoo/config/catpoo-site /etc/apache2/sites-available/catpoo-site

#
# Configure system settings
#
- hosts: catpoo
  sudo: yes
  tasks:
  - copy: dest=/etc/network/interfaces src=files/etc/network/interfaces

  - copy: dest=/etc/dhcp/dhcpd.conf src=files/etc/dhcp/dhcpd.conf

  - command: mkdir -p /etc/bind/zones
  - copy: dest=/etc/bind/zones/catpoo.local.zone src=files/etc/bind/zones/catpoo.local.zone
  - copy: dest=/etc/bind/zones/rev.37.13.10-in-addr.arpa src=files/etc/bind/zones/rev.37.13.10-in-addr.arpa
  - copy: dest=/etc/bind/named.conf.local src=files/etc/bind/named.conf.local
  - copy: dest=/etc/bind/bad-hosts.conf src=files/etc/bind/bad-hosts.conf

  - copy: dest=/etc/default/isc-dhcp-server src=files/etc/default/isc-dhcp-server

  - copy: dest=/etc/default/hostapd src=files/etc/default/hostapd
  - copy: dest=/etc/hostapd/hostapd.conf src=files/etc/hostapd/hostapd.conf

  - lineinfile: dest=/etc/sysctl.conf line="net.ipv4.ip_forward=1"

  - copy: dest=/etc/motd src=files/etc/motd
  - copy: dest=/etc/rc.local src=files/etc/rc.local
  - copy: dest=/etc/iptables.rules src=files/etc/iptables.rules

  - command: rm -f /etc/apache2/sites-available/catpoo
  - command: a2dissite 000-default
  - command: a2ensite catpoo-site

